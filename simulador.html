<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Precifica√ß√£o ‚Äì Simulador</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Simule pre√ßo de venda, markup, margem de contribui√ß√£o, lucro e ponto de equil√≠brio em poucos segundos." />
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <div class="mx-auto max-w-5xl px-4 py-8">
    <header class="mb-6 flex flex-col items-start justify-between gap-3 sm:flex-row sm:items-center">
      <div>
        <h1 class="text-2xl font-bold">Calculadora de Precifica√ß√£o</h1>
        <p class="text-sm text-gray-600">Insira seus dados e veja os resultados na hora</p>
      </div>
      <a id="ctaVendas" href="#" target="_blank" class="rounded-2xl bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:opacity-90">Quero dominar a precifica√ß√£o</a>
    </header>

    <div class="grid gap-6 md:grid-cols-2">
      <section class="rounded-2xl border bg-white p-6 shadow-sm">
        <h2 class="mb-4 text-lg font-semibold">Entradas</h2>
        <div class="mb-4">
          <label class="mb-1 block text-sm font-medium">Custo unit√°rio (R$)</label>
          <input id="custo" type="number" inputmode="decimal" min="0" step="0.01" class="w-full rounded-xl border px-3 py-2 outline-none focus:ring-2" placeholder="Ex.: 50,00" />
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="mb-1 block text-sm font-medium">Impostos (% do pre√ßo)</label>
            <input id="impostos" type="number" min="0" step="0.1" value="0" class="w-full rounded-xl border px-3 py-2 outline-none focus:ring-2" />
          </div>
          <div>
            <label class="mb-1 block text-sm font-medium">Taxas/Cart√£o (% do pre√ßo)</label>
            <input id="taxas" type="number" min="0" step="0.1" value="0" class="w-full rounded-xl border px-3 py-2 outline-none focus:ring-2" />
          </div>
          <div>
            <label class="mb-1 block text-sm font-medium">Comiss√£o (% do pre√ßo)</label>
            <input id="comissao" type="number" min="0" step="0.1" value="0" class="w-full rounded-xl border px-3 py-2 outline-none focus:ring-2" />
          </div>
          <div>
            <label class="mb-1 block text-sm font-medium">Margem de lucro desejada (% do pre√ßo)</label>
            <input id="margem" type="number" min="0" step="0.1" value="0" class="w-full rounded-xl border px-3 py-2 outline-none focus:ring-2" />
          </div>
        </div>
        <div class="mt-4">
          <label class="mb-1 block text-sm font-medium">Custos fixos mensais (R$) ‚Äî opcional</label>
          <input id="fixos" type="number" inputmode="decimal" min="0" step="0.01" class="w-full rounded-xl border px-3 py-2 outline-none focus:ring-2" placeholder="Para calcular o ponto de equil√≠brio" />
        </div>
        <div class="mt-6 flex gap-3">
          <button id="limpar" class="rounded-2xl border px-4 py-2 text-sm hover:bg-white">Limpar</button>
        </div>
      </section>

      <section class="rounded-2xl border bg-white p-6 shadow-sm">
        <h2 class="mb-4 text-lg font-semibold">Resultados</h2>
        <div class="grid gap-3">
          <div class="rounded-xl border p-4"><div class="text-xs text-gray-500">Pre√ßo sugerido</div><div id="preco" class="text-2xl font-semibold">R$ 0,00</div></div>
          <div class="grid grid-cols-2 gap-3">
            <div class="rounded-xl border p-4"><div class="text-xs text-gray-500">Markup</div><div id="markup" class="font-semibold">0,00x</div></div>
            <div class="rounded-xl border p-4"><div class="text-xs text-gray-500">Lucro por unidade</div><div id="lucro" class="font-semibold">R$ 0,00</div></div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="rounded-xl border p-4"><div class="text-xs text-gray-500">Margem de contribui√ß√£o</div><div id="margR" class="font-semibold">R$ 0,00</div></div>
            <div class="rounded-xl border p-4"><div class="text-xs text-gray-500">Margem de contribui√ß√£o %</div><div id="margP" class="font-semibold">0,0%</div></div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="rounded-xl border p-4"><div class="text-xs text-gray-500">Impostos (R$)</div><div id="impR" class="font-semibold">R$ 0,00</div></div>
            <div class="rounded-xl border p-4"><div class="text-xs text-gray-500">Taxas/Cart√£o (R$)</div><div id="taxR" class="font-semibold">R$ 0,00</div></div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="rounded-xl border p-4"><div class="text-xs text-gray-500">Comiss√£o (R$)</div><div id="comR" class="font-semibold">R$ 0,00</div></div>
            <div class="rounded-xl border p-4"><div class="text-xs text-gray-500">Custos vari√°veis (R$)</div><div id="cvR" class="font-semibold">R$ 0,00</div></div>
          </div>
          <div class="rounded-xl border p-4 hidden" id="peWrap"><div class="text-xs text-gray-500">Ponto de equil√≠brio (qtd.)</div><div id="pe" class="font-semibold">‚Äî</div></div>
        </div>
        <p class="mt-6 text-xs text-gray-500">F√≥rmula: Pre√ßo = Custo / (1 - (Impostos% + Taxas% + Comiss√£o% + Margem%)). Margem informada = lucro l√≠quido desejado sobre o pre√ßo.</p>
      </section>
    </div>

    <!-- ===== Feedback de Satisfa√ß√£o (5 estrelas + texto) ===== -->
    <section class="mt-10 rounded-2xl border bg-white p-6 shadow-sm">
      <h2 class="mb-2 text-lg font-semibold">Avalie a Calculadora</h2>
      <p class="mb-4 text-sm text-gray-600">Clique nas estrelas e, se quiser, deixe uma sugest√£o. Isso leva menos de 10 segundos. üôå</p>

      <!-- Estrelas -->
      <div id="nc-stars" class="flex items-center gap-2" aria-label="Avalia√ß√£o em estrelas (1 a 5)">
        <button type="button" class="nc-star text-2xl" data-value="1" aria-label="1 estrela" title="1 estrela">‚òÖ</button>
        <button type="button" class="nc-star text-2xl" data-value="2" aria-label="2 estrelas" title="2 estrelas">‚òÖ</button>
        <button type="button" class="nc-star text-2xl" data-value="3" aria-label="3 estrelas" title="3 estrelas">‚òÖ</button>
        <button type="button" class="nc-star text-2xl" data-value="4" aria-label="4 estrelas" title="4 estrelas">‚òÖ</button>
        <button type="button" class="nc-star text-2xl" data-value="5" aria-label="5 estrelas" title="5 estrelas">‚òÖ</button>
        <span id="nc-stars-hint" class="ml-2 text-sm text-gray-500"></span>
      </div>

      <!-- Caixa de texto opcional -->
      <div class="mt-4">
        <label for="nc-feedback" class="mb-1 block text-sm font-medium">Sugest√£o de melhoria (opcional)</label>
        <textarea id="nc-feedback" rows="3" class="w-full rounded-xl border px-3 py-2 outline-none focus:ring-2" placeholder="O que podemos melhorar?"></textarea>
        <div class="mt-1 text-xs text-gray-500" id="nc-count">0/600</div>
      </div>

      <!-- A√ß√µes -->
      <div class="mt-4 flex items-center gap-3">
        <button id="nc-send" class="rounded-2xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:opacity-90 disabled:opacity-60 disabled:cursor-not-allowed" disabled>
          Enviar avalia√ß√£o
        </button>
        <span id="nc-msg" class="text-sm"></span>
      </div>
    </section>

    <footer class="mt-10 text-center text-xs text-gray-500">¬© <span id="year2"></span> Neg√≥cio no Comando ‚Äî Calculadora educativa.</footer>
  </div>

  <script>
    document.getElementById('year2').textContent = new Date().getFullYear();
    const URL_CTA_VENDAS = "https://vendas.negocionocomando.com.br"; // opcional
    document.getElementById('ctaVendas').href = URL_CTA_VENDAS;

    const fmt = (n) => (isFinite(n) ? n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00');

    const els = {
      custo: document.getElementById('custo'),
      impostos: document.getElementById('impostos'),
      taxas: document.getElementById('taxas'),
      comissao: document.getElementById('comissao'),
      margem: document.getElementById('margem'),
      fixos: document.getElementById('fixos'),
      preco: document.getElementById('preco'),
      markup: document.getElementById('markup'),
      lucro: document.getElementById('lucro'),
      margR: document.getElementById('margR'),
      margP: document.getElementById('margP'),
      impR: document.getElementById('impR'),
      taxR: document.getElementById('taxR'),
      comR: document.getElementById('comR'),
      cvR: document.getElementById('cvR'),
      peWrap: document.getElementById('peWrap'),
      pe: document.getElementById('pe'),
      limpar: document.getElementById('limpar')
    };

    const calc = () => {
      const C = Number(els.custo.value) || 0;
      const I = (Number(els.impostos.value) || 0) / 100;
      const T = (Number(els.taxas.value) || 0) / 100;
      const K = (Number(els.comissao.value) || 0) / 100;
      const M = (Number(els.margem.value) || 0) / 100;

      const denom = 1 - (I + T + K + M);
      const PV = denom > 0 ? C / denom : 0;

      const impostosR = PV * I;
      const taxasR = PV * T;
      const comissaoR = PV * K;
      const lucro = PV * M;
      const custoVarTotal = C + impostosR + taxasR + comissaoR;
      const margR = PV - custoVarTotal;
      const margP = PV > 0 ? (margR / PV) * 100 : 0;
      const markup = C > 0 ? PV / C : 0;

      els.preco.textContent = fmt(PV);
      els.markup.textContent = `${markup.toFixed(2)}x`;
      els.lucro.textContent = fmt(lucro);
      els.margR.textContent = fmt(margR);
      els.margP.textContent = `${margP.toFixed(1)}%`;
      els.impR.textContent = fmt(impostosR);
      els.taxR.textContent = fmt(taxasR);
      els.comR.textContent = fmt(comissaoR);
      els.cvR.textContent = fmt(custoVarTotal);

      const fixos = Number(els.fixos.value) || 0;
      if (fixos > 0 && margR > 0) {
        els.pe.textContent = (fixos / margR).toFixed(2) + ' un.';
        els.peWrap.classList.remove('hidden');
      } else {
        els.peWrap.classList.add('hidden');
      }
    };

    ['input', 'change'].forEach(evt => {
      ['custo','impostos','taxas','comissao','margem','fixos'].forEach(id => {
        els[id].addEventListener(evt, calc);
      });
    });

    els.limpar.addEventListener('click', (e) => {
      e.preventDefault();
      ['custo','impostos','taxas','comissao','margem','fixos'].forEach(id => els[id].value = id === 'impostos' ? 10 : id === 'taxas' ? 3 : id === 'margem' ? 20 : '');
      calc();
    });

    calc();

    /* ================== FEEDBACK / AVALIA√á√ÉO ================== */

    // Usa sua implanta√ß√£o e for√ßa roteamento por querystring:
    const FEEDBACK_URL = "https://script.google.com/macros/s/AKfycbzGBscJcPOv5bhjdJBV1FUJ_FbKzSmSq4RYS1HxKFH7__fmQnk9J76QyDkz5--o2D2WWg/exec?kind=calc_feedback";

    // Captura UTMs da p√°gina do simulador (se existirem)
    const _qs = new URLSearchParams(location.search);
    const _utm = {
      utm_source:   _qs.get('utm_source')   || '',
      utm_medium:   _qs.get('utm_medium')   || '',
      utm_campaign: _qs.get('utm_campaign') || '',
      utm_term:     _qs.get('utm_term')     || '',
      utm_content:  _qs.get('utm_content')  || ''
    };

    // Elementos
    const $stars     = Array.from(document.querySelectorAll('.nc-star'));
    const $hint      = document.getElementById('nc-stars-hint');
    const $txt       = document.getElementById('nc-feedback');
    const $count     = document.getElementById('nc-count');
    const $send      = document.getElementById('nc-send');
    const $msg       = document.getElementById('nc-msg');

    // Estado
    let selected = 0;
    const MAX_CHARS = 600;
    const STORAGE_KEY = 'nc_calc_feedback_submitted';

    // Se j√° enviou neste navegador, desabilita tudo
    const already = localStorage.getItem(STORAGE_KEY) === '1';
    if (already) {
      $send.disabled = true;
      $stars.forEach(b => b.disabled = true);
      $txt.disabled = true;
      $msg.className = 'text-emerald-700 text-sm';
      $msg.textContent = 'Obrigado! Sua avalia√ß√£o j√° foi registrada neste dispositivo.';
    }

    // Helpers de visual e acessibilidade
    const paint = (n) => {
      $stars.forEach((b, i) => {
        const on = i < n;
        b.classList.toggle('text-yellow-400', on);
        b.classList.toggle('text-gray-300', !on);
        b.classList.toggle('scale-110', on && i === n - 1);
      });
      const map = {1:'Ruim',2:'Regular',3:'Ok',4:'Boa',5:'Excelente'};
      $hint.textContent = n ? `(${n} / 5 ‚Äî ${map[n]})` : '';
    };

    // Eventos das estrelas
    $stars.forEach((btn) => {
      const val = Number(btn.dataset.value);
      btn.addEventListener('mouseenter', () => !already && paint(val));
      btn.addEventListener('focus', () => !already && paint(val));
      btn.addEventListener('mouseleave', () => !already && paint(selected));
      btn.addEventListener('blur', () => !already && paint(selected));
      btn.addEventListener('click', () => {
        if (already) return;
        selected = val;
        paint(selected);
        $send.disabled = selected < 1;
        $msg.textContent = '';
      });
    });

    // Contador de caracteres
    $txt.addEventListener('input', () => {
      if ($txt.value.length > MAX_CHARS) {
        $txt.value = $txt.value.slice(0, MAX_CHARS);
      }
      $count.textContent = `${$txt.value.length}/${MAX_CHARS}`;
    });

    // Envio
    $send.addEventListener('click', async () => {
      if (already) return;
      if (selected < 1) {
        $msg.className = 'text-red-600 text-sm';
        $msg.textContent = 'Clique em 1 a 5 estrelas para enviar.';
        return;
      }

      const payload = {
        kind      : 'calc_feedback',   // redundante, ajuda o servidor
        rating    : selected,          // 1..5
        comment   : ($txt.value || '').trim(),
        page_url  : location.href,
        user_agent: navigator.userAgent,
        ts        : new Date().toISOString(),
        ..._utm
      };

      $send.disabled = true;
      $send.textContent = 'Enviando‚Ä¶';
      $msg.textContent = '';

      const okDone = () => {
        localStorage.setItem(STORAGE_KEY, '1');
        $msg.className = 'text-emerald-700 text-sm';
        $msg.textContent = 'Obrigado! Avalia√ß√£o registrada. üôå';
        $stars.forEach(b => b.disabled = true);
        $txt.disabled = true;
        $send.textContent = 'Enviado! ‚úÖ';
      };

      try {
        const res = await fetch(FEEDBACK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          try {
            navigator.sendBeacon?.(
              FEEDBACK_URL,
              new Blob([JSON.stringify(payload)], { type: 'text/plain' })
            );
          } catch {}
        }
        okDone();
      } catch (err) {
        try {
          navigator.sendBeacon?.(
            FEEDBACK_URL,
            new Blob([JSON.stringify(payload)], { type: 'text/plain' })
          );
          okDone();
        } catch {
          $send.disabled = false;
          $send.textContent = 'Enviar avalia√ß√£o';
          $msg.className = 'text-orange-600 text-sm';
          $msg.textContent = 'Quase l√°‚Ä¶ confira sua conex√£o e tente novamente.';
        }
      }
    });

    paint(0);
  </script>
</body>
</html>
